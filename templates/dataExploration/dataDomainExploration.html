{% extends 'layout.html' %}
{% block content%}
<link href={{url_for('static', filename="css/exploration.css" )}} rel="stylesheet">

<!--start container fluid-->
<div class="container-fluid">
	<div class='row mt-4'>
		<div class="col-xl-10 col-lg-10">
			<div class="card shadow mb-4">
				<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
					<h5 class="font-weight-bold text-gray-900">Domain Data Clustring Setting </h5>
				</div>
				<!--start card body-->
				<div class="card-body">
					<div class="card-body-inn domain_div">
						<div class='mb-4'>
							<span class="font-weight-bold text-primary text-lg">DOMAIN</span>
						</div>
						<div class='mb-2'>
							<select id='dataDomain'
								class='form-control btn btn-deep-navy dropdown no-arrow  rounded-0 cycleSelectBox'></select>
						</div>
						<div class='mb-1 roundBox'>
							<div class="row">
								<div class='mb-3 rountTitle'>
									<span class="text-gray-900">· Time Duration</span>
								</div>
								<div class=''>
									<div class='box_form mb-3'>
										<input type="date" id='startTime'
											class='form-control btn btn-deep-navy dropdown no-arrow box_input rounded-0'
											onchange="setDuration();" />
										&nbsp;-&nbsp;
										<input type="date" id='endTime'
											class='form-control btn btn-deep-navy dropdown no-arrow box_input rounded-0'
											onchange="setDuration();" />
									</div>

									<div class='box_form mb-3'>
										<span>(</span>
										<input type="text" class='form-control btn btn-secondary rounded-0'
											id="duration">
										<span>days, frequency :</span>
										<input type="text" disabled id='o_frequency' value=""
											class='form-control btn btn-secondary box_input rounded-0' />
									</div>
									<span>)</span>
								</div>
							</div>
							<div class="row">
								<div class="mb-3 rountTitle">
									<span class="text-gray-900">· Duration (days)</span>
								</div>
								<div class='mb-3'>
									<div class="box_form">
										<input type="number" id='durationSet'
											class='form-control btn btn-deep-navy dropdown no-arrow box_input rounded-0'
											onchange="changeDuration();" />
									</div>
								</div>
							</div>

						</div>
					</div>

					<div class="card-body-inn cluster_div">
						<div style="border-top: 1px solid rgb(204, 204, 204);"></div>
						<div class='mt-4 mb-4'>
							<span class=" font-weight-bold text-primary text-lg">Clustering Parameter</span>
						</div>

						<div class="roundBox">
							<div class='row mb-3'>
								<div class="  text-gray-900 rountTitle"><span>· NaN Check</span></div>
								<div class="  ">
									<div class="box_block">
										<div class="box_subject">
											Consecutive
										</div>
										<div class="box_form">
											<input type="number" id='consecutiveNanLimit' value=1
												class='form-control btn btn-miranda dropdown no-arrow box_input rounded-0' />
										</div>
									</div>
									<div class="box_block">
										<div class="box_subject">
											Total
										</div>
										<div class="box_form">
											<input type="number" id='totalNaNLimit' value=10
												class='form-control btn btn-miranda dropdown no-arrow  box_input rounded-0' />
										</div>
									</div>
								</div>
							</div>
							<div class='row'>
								<div class=" text-gray-900 rountTitle"><span>· Target</span></div>
								<div class=" mb-3">
									<div class="box_block">
										<div class="box_subject">feature</div>
										<div class="box_form">
											<select id='target'
												class='form-control btn btn-miranda dropdown no-arrow  box_select rounded-0 '></select>
										</div>
									</div>
									<div class="box_block">
										<div class="box_subject">frequency (min)</div>
										<div class="box_form">
											<input type="number" id='frequency' value=60
												class='form-control btn btn-miranda dropdown no-arrow box_input rounded-0' />
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class='submitBox mb-4'>
							<a href="#" class="btn btn-lg rounded-0" id='start_cluster'>
								submit&nbsp;<i class="fa fa-check" aria-hidden="true" id="start_btn"></i>
							</a>
						</div>
					</div>
				</div>
				<!--//end card body-->
			</div>

		</div>

	</div>

	<!--start graph result area-->
	<div id="ms_list_cnt" class="text-gray-900 p-2 mt-4"></div>
	<div class='row graph_result_area mt-1'>
		<div class="col-xl-10 col-lg-10">
			<div class="card shadow mb-4">
				<div class="card-body">
					<div id="ms_graph_list">

						<table class="tg">
							<tbody>
								<tr>
									<td class="tg-0lax" id="canvas_0"></td>
									<td class="tg-0lax" id="canvas_1"></td>
									<td class="tg-0lax" id="canvas_2"></td>
									<td class="tg-0lax" id="canvas_3"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--//end greph result area-->

	<div class='row mb-5'>
		<div class="col-xl-10 col-lg-10">
			<div class="card shadow mb-4">
				<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
					<h5 class="font-weight-bold text-gray-900">Clustring result based on all data witin a specific
						doamin</h5>
				</div>
				<div class="card-body" id="result_area">
					<div class='row mb-5'>
						<!--start first block-->
						<div class="col-xl-6 col-lg-10">
							<div class="d-sm-flex align-items-center justify-content-between mb-4">
								<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
									<div class="btn-group mr-2" role="group" aria-label="First group" id="clustering">
										<button type="button" class="btn cluster_info " id="pattern">pattern</button>
										<button type="button" class="btn cluster_info " id="count">count</button>
									</div>
								</div>
							</div>
							<div id="result_contents1" class="mt-4 mb-4">
								<div class="result col">
									<canvas id="cluster_count" class="cluster_bar"></canvas>
									<img class="fit-picture" src="" id="cluster_pattern" alt="cluster pattern">
								</div>

							</div>
						</div>
						<!--//end second block-->
						<!--start second block-->
						<div class="col-xl-4 col-lg-10">
							<span style="color: #505050; font-size: 1.2em;">Result Table</span>
							<div id="result_contents2" class="mt-4">
								<div id="result_table" class="table-responsive">
									<table class="table table-bordered tg" id="cluster_table">
										<thead class="" style="background: #494949; color: white;">
											<tr>
												<th class="tg-ujoh">Table Name</th>
												<th class="tg-ujoh">Cluster Number</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td colspan="2"></td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
						<!--//end second block-->
					</div>

				</div>
			</div>
		</div>
	</div>
</div>
<!--//end container fluid-->
<div id="loading-prograss" class="loading-prograss" style="display:none;">
	<div class="spinner-border text-danger" role="status">
		<span class="sr-only">Loading...</span>
	</div>
	<div class="text-danger">Loading Data</div>
</div>

{% endblock %}
{% block script %}

<script src={{url_for('static', filename="js/Chart.js" )}}></script>
<script src={{url_for('static', filename="js/custom_ui.js" )}}></script>
<script type="text/javascript" charset="utf8">
	// ===== const =====
	const width_ratio = 3 / 14
	const canvas_cnt = 4
	const START_BTN = "fa-check"
	const RETURN_BTN = "fa-reply"
	const MS_LSIT_URL = '/DataIngestion/measurement_list'
	const CLUSTERING_URL = '/DataDomainExploration/clustering'
	const ONE_TABLE_URL = '/DataDomainExploration/preprocessing'
	const GET_DB_LIST = '/DataIngestion/db_list'
	// ===== const end =====

	// ===== for graph =====
	var labels = ['0', '1', '2', '3', '4', '5', '6'];
	var data = {
		labels: labels,
		datasets: [{
			label: 'Line Graph',
			backgroundColor: 'rgb(255, 99, 132)',
			borderColor: 'rgb(255, 99, 132)',
			data: [],
		}]
	};
	var config = {
		type: 'line',
		data: data,
		options: {}
	};

	var bar_data = {
		labels: ['1', '2', '3', '4', '5', '6',],
		datasets: [{
			label: 'The Number of tables on cluster',
			data: [65, 59, 80, 81, 56, 55, 40],
			backgroundColor: [
				'rgba(255, 99, 132, 0.2)',
				'rgba(255, 159, 64, 0.2)',
				'rgba(255, 205, 86, 0.2)',
				'rgba(75, 192, 192, 0.2)',
				'rgba(54, 162, 235, 0.2)',
				'rgba(153, 102, 255, 0.2)',
				'rgba(201, 203, 207, 0.2)'
			],
			borderColor: [
				'rgb(255, 99, 132)',
				'rgb(255, 159, 64)',
				'rgb(255, 205, 86)',
				'rgb(75, 192, 192)',
				'rgb(54, 162, 235)',
				'rgb(153, 102, 255)',
				'rgb(201, 203, 207)'
			],
			borderWidth: 1
		}]
	};
	var bar_config = {
		type: 'bar',
		data: bar_data,
		options: { responsive: true, scales: { yAxes: [{ display: true, ticks: { suggestedMin: 0, beginAtZero: true } }] } },
	};
	// ===== for graph end =====

	// ===== variable =====
	var selectedDB = '';
	var selectedMS = '';
	var cnt = 0;
	var cluster_res_mode = 0; // 0 = count, 1 = pattern
	var is_processing = false; // Indicates whether processing is currently in progress or not.
	var myBarChart;
	var duration_day
	var ms_list
	var width;
	// ===== variable end =====

	$.get(GET_DB_LIST, function (result) {
		result = JSON.parse(result)
		db_list = result['result']
		makeSelect(db_list, 'dataDomain');
	});

	$('#dataDomain').on('change', function () {

		$.ajaxSetup({ async: false });

		selectedDB = this.value;
		get_url1 = '/DataIngestion/featureListforFirstMS/' + selectedDB;

		var text = getValueDataByAjax(get_url1, {}, "get", "result");
		makeSelect(text, "target", btn = true);

		get_url2 = '/DataIngestion/frequencyForFirstMS/' + selectedDB
		var text = getValueDataByAjax(get_url2, {}, "get", "result");
		$("#o_frequency").val(text);

		get_url3 = '/DataIngestion/startTimeForFirstMS/' + selectedDB
		$.get(get_url3, function (data) {
			result = JSON.parse(data)['result']
			$("#startTime").val(result.split(' ')[0]);
		})
		get_url4 = '/DataIngestion/lastTimeForFirstMS/' + selectedDB
		$.get(get_url4, function (data) {
			result = JSON.parse(data)['result']
			$("#endTime").val(result.split(' ')[0]);
		})

		$("#durationSet").val('');
		$("#duration").val(getDuration());

		$.ajaxSetup({ async: true });
	});

	$('#pattern').on('click', function () {
		cluster_res_mode = 1;
		$("#cluster_count").css("display", "none");
		$("#cluster_pattern").css("display", "block");


		$(this).addClass('clust_btn_on');
		$('#count').removeClass('clust_btn_on');

	});

	$('#count').on('click', function () {
		cluster_res_mode = 0;
		$("#cluster_pattern").css("display", "none");
		$("#cluster_count").css("display", "block");

		$(this).addClass('clust_btn_on');
		$('#pattern').removeClass('clust_btn_on');
	});

	/*
	Duration 구하는 함수
	*/
	function getDuration() {
		const startDt = $("#startTime").val();
		const endDt = $("#endTime").val();

		const date1 = new Date(startDt);
		const date2 = new Date(endDt);

		if (date1 > date2) {
			alert("Time Information 시작 날짜와 종료 날짜를 확인해 주세요.");
			return false;
		}

		const diffDate = date1.getTime() - date2.getTime();
		const dateDays = Math.abs(diffDate / (1000 * 3600 * 24));

		return dateDays;
	}
	function setDuration() {
		$("#duration").val(getDuration());
	}
	function addDays(date, days) {
		var result = new Date(date);
		var intday = parseInt(days);
		result.setDate(result.getDate() + intday);

		return result;
	}
	//ing
	function changeDuration() {
		const startDt = $("#startTime").val();
		const setDt = $("#durationSet").val();
		var result = addDays(startDt, setDt);
		const year = result.getFullYear(); const month = result.getMonth() + 1; const date = result.getDate();
		result = `${year}-${month >= 10 ? month : '0' + month}-${date >= 10 ? date : '0' + date}`;
		$("#endTime").val(result);

		setDuration();

	}

	$('#start_cluster').on('click', function () {
		// console.log(is_processing)	


		let domainValue = $("#dataDomain>option:selected").attr("value");
		if (domainValue == undefined) {
			alert("Domain을 선택해 주세요.");
			return;
		}

		let feature = $("select[id='target']>option:selected").attr("value");
		if (feature == undefined) {
			alert("feature을 선택해 주세요.");
			return;
		}

		$(".graph_result_area").show();
		make_empty();

		let start_btn = $("#start_btn");

		//if(start_btn.hasClass(START_BTN)){ //2022.03.30 start button disable 기능 제거
		if (true) {
			is_processing = true;
			selectedDB = $('#dataDomain').val();
			start_time = $("#startTime").val();
			duration_day = getDuration();
			consecutiveNanLimit = $("#consecutiveNanLimit").val() * 1
			totalNaNLimit = $("#totalNaNLimit").val() * 1
			sample = $("#frequency").val()

			if (duration_day == 0) duration_day = 1
			if (consecutiveNanLimit == 0) consecutiveNanLimit = 10
			if (totalNaNLimit == 0) totalNaNLimit = 1
			if (sample == null) sample = "1H"

			let params = {
				"db_name": selectedDB,
			}
			let params2 = {
				"db_name": selectedDB,
				"start_time": start_time + " 00:00:00",
				"nanLimitInfo": { 'type': 'num', 'ConsecutiveNanLimit': consecutiveNanLimit, 'totalNaNLimit': totalNaNLimit },
				"duration_day": duration_day,
				"column_names": [feature],
				"resampling_rate": sample
			}

			$.ajax({
				url: MS_LSIT_URL + '/' + selectedDB,
				success: function (result) {
					result = JSON.parse(result);
					ms_list = result['result'];

					for (i in ms_list) {
						params2['ms_name'] = ms_list[i];
						$("#ms_list_cnt").html("total graph count : " + ms_list.length);

						request_post(
							ONE_TABLE_URL,
							params2,
							function (result) {
								print_one_table(result);
							}
						)
					}
				},
				error: function (e) {
					alert(e);
				}
			});


			request_post(
				CLUSTERING_URL,
				params2,
				function (result) {
					if (result.status !== 200) {
						alert("clustering 값이 나오지 않습니다. 로그를 확인해 주세요."); return;
					}
					msg = result.responseJSON;

					print_result(msg);
					print_result_img(msg);
				}
			);

			start_btn.removeClass(START_BTN);
			start_btn.addClass(RETURN_BTN);
		}
		else if (start_btn.hasClass(RETURN_BTN)) {
			is_processing = false
			start_btn.removeClass(RETURN_BTN)
			start_btn.addClass(START_BTN)
			$("#target").attr("disabled", false)
		}
	})

	function make_empty() {
		for (i = 0; i < canvas_cnt; ++i) {
			$("#canvas_" + i).empty();
		}
		$('#cluster_count').empty();
		$("#cluster_table tbody").empty();
		if (myBarChart != undefined) {
			myBarChart.destroy();
		}
		cnt = 0;
		$('#cluster_pattern').attr("src", "");
	}

	function fill_table(result) {
		/*
			result = {
				"key1":"value1",
				"key2":"value2",
			}
		*/
		var real_table = $("#cluster_table tbody")
		ms = Object.keys(result)
		ms.forEach(element => {
			row = $('<tr></tr>')
			row.append('<td class="tg-13pz">' + element + '</td>')
			row.append('<td class="tg-13pz">' + result[element] + '</td>')
			real_table.append(row)
		});
		row = $('<tr></tr>')
		row.append('<td class="tg-13pz">TOTAL</td>')
		row.append('<td class="tg-13pz">' + ms.length + '</td>')
		real_table.append(row)
	}

	function print_result_img(msg) {
		if (msg["img"] == undefined) {
			alert("해당 Clustring result 이미지가 없습니다.");
			return;
		}

		$("#count").addClass("clust_btn_on");
		$("#cluster_pattern").attr("src", 'data:image/png;base64,' + msg["img"]);
		$("#cluster_pattern").css("width", "100%");

	}

	function print_result(msg) {
		let json_data = msg['data'];

		if (msg["data"] == undefined) {
			alert("해당 Domain의 데이터가 없습니다.");
			is_processing = false;
			return;
		}
		if (Object.keys(json_data).length <= 0) {
			is_processing = false
			return
		}
		var table = {
			"table_name": [],
			"cluster": []
		}
		for (key in json_data) {
			table["table_name"].push(key);
			table["cluster"].push(json_data[key]);
		}
		// fill table
		fill_table(json_data);
		var counts = {};
		var sampleArray = Object.values(json_data);
		sampleArray.forEach(function (x) { counts[x] = (counts[x] || 0) + 1; });
		temp = $.extend(true, {}, bar_data);
		temp["labels"] = Object.keys(counts);
		for (i in temp["labels"]) {
			temp["labels"][i] = "Cluster " + temp["labels"][i];
		}

		temp["datasets"][0]["data"] = Object.values(counts);
		tempConf = $.extend(true, {}, bar_config);
		tempConf["data"] = temp;
		myBarChart = new Chart(
			document.getElementById("cluster_count"),
			tempConf
		);

		if (cluster_res_mode == 1) {
			$("#cluster_count").css("display", "none");
		}
		is_processing = false;
	}

	function checkFlag(flag) {
		//console.log(flag)
		if (flag == 1) {
			// It has all data
			color = "LightCoral"
		}
		else if (flag == 0) {
			// It has nan data
			color = "gray"
		}
		else {
			// It doesn't have data
			color = "BurlyWood"
		}
		return color
	}

	function print_one_table(result) {

		const msg = result.responseJSON;
		canvasName = "#canvas_" + (cnt % canvas_cnt)
		chartName = "myChart" + cnt
		ele = '<canvas id="' + chartName + '" class="ms_graph"></canvas>'
		$(canvasName).append(ele)

		//2022.04.01
		temp = $.extend(true, {}, data);
		if (msg !== undefined) {
			color = checkFlag(msg["flag"])
			temp["datasets"][0]["data"] = msg["data"]
			temp["datasets"][0]["label"] = msg["table"]
			temp["labels"] = [...Array(msg["data"].length).keys()];
			temp["datasets"][0]["backgroundColor"] = color
			temp["datasets"][0]["borderColor"] = color
		} else {
			color = checkFlag(2);
		}

		tempConf = $.extend(true, {}, config);
		tempConf["data"] = temp

		var myChart = new Chart(
			document.getElementById(chartName),
			tempConf
		);

		cnt += 1;
	}

	$(document).ready(function () {
		$("#cluster_pattern").css("display", "none")
		// var myChart;
		var graph_part_width = $('#ms_graph_list').width()
		width = graph_part_width * (width_ratio)
		window.addEventListener('resize', function (event) {
			graph_part_width = $('#ms_graph_list').width()
			width = graph_part_width * (width_ratio)
			$(".ms_graph").width(width)
		}, true);

		$(document).ajaxStart(function () {
			$("#loading-prograss").show();
			$("#loading-prograss").show().css({
				top: $(document).scrollTop() + ($(window).height()) / 3 + 'px',
				left: ($(window).width()) / 2.5 + 'px'
			});

		});
		$(document).ajaxStop(function () {
			$("#loading-prograss").hide();
		});

		$(document).ajaxError(function () {
			$("#loading-prograss").hide();
			alert("이슈가 발생했습니다. 로그를 확인해 주세요.");

		});


	});
</script>

{% endblock %}